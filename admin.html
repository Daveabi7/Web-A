<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Медіа</title>
  <style>
    body{font-family:Arial, sans-serif;padding:20px;background:#111;color:#fff}
    .card{background:#222;padding:20px;border-radius:8px;max-width:720px;margin:12px auto}
    label{display:block;margin:10px 0 6px}
    input[type=text], input[type=file]{width:100%;padding:8px;border-radius:4px;border:1px solid #333;background:#111;color:#fff}
    button{margin-top:12px;padding:10px 14px;background:#ffd200;color:#000;border:none;border-radius:4px;cursor:pointer}
    .hidden{display:none}
    .row{display:flex;gap:10px}
    .item-list{margin-top:16px}
    .item{padding:10px;background:#111;border:1px solid #333;border-radius:6px;margin-bottom:8px}
  </style>
</head>
<body>
  <div class="card" id="auth-card">
    <h2>Вхід в адмінку</h2>
    <form id="login-form">
      <label>Email</label>
      <input id="email" type="text" required />
      <label>Пароль</label>
      <input id="password" type="password" required />
      <button type="submit">Увійти</button>
    </form>
  </div>

  <div class="card hidden" id="admin-card">
    <h2>Додати медіа-матеріал</h2>
    <form id="media-form">
      <label>Заголовок</label>
      <input type="text" id="title" required />
      <label>Тег (наприклад: інтервʼю)</label>
      <input type="text" id="tag" />
      <label>Колір тегу (green, yellow, ...)</label>
      <input type="text" id="tagColor" value="green" />
      <label>Картинка (файл)</label>
      <input type="file" id="image" accept="image/*" />
      <div class="row">
        <button type="submit">Додати</button>
        <button id="logout" type="button">Вийти</button>
      </div>
    </form>

    <h3>Список матеріалів</h3>
    <div id="items" class="item-list"></div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, getDocs, orderBy, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "REPLACE_API_KEY",
    authDomain: "REPLACE_AUTH_DOMAIN",
    projectId: "REPLACE_PROJECT_ID",
    storageBucket: "REPLACE_STORAGE_BUCKET",
    messagingSenderId: "REPLACE_SENDER_ID",
    appId: "REPLACE_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const loginForm = document.getElementById('login-form');
  const adminCard = document.getElementById('admin-card');
  const authCard = document.getElementById('auth-card');
  const mediaForm = document.getElementById('media-form');
  const itemsEl = document.getElementById('items');
  const logoutBtn = document.getElementById('logout');

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (err) {
      alert('Ошибка входа: ' + err.message);
      console.error(err);
    }
  });

  logoutBtn.addEventListener('click', async () => {
    await signOut(auth);
  });

  onAuthStateChanged(auth, user => {
    if (user) {
      authCard.classList.add('hidden');
      adminCard.classList.remove('hidden');
      loadItems();
    } else {
      authCard.classList.remove('hidden');
      adminCard.classList.add('hidden');
    }
  });

  async function loadItems() {
    itemsEl.innerHTML = 'Завантаження...';
    const q = query(collection(db, 'media'), orderBy('date', 'desc'));
    const snap = await getDocs(q);
    itemsEl.innerHTML = '';
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <strong>${d.title || '(без заголовку)'}</strong><div>${d.tag || ''}</div>
        <div style="margin-top:8px;"><img src="${d.imageUrl || ''}" style="max-width:200px;display:block;margin-top:6px" /></div>
        <div style="margin-top:6px"><button data-id="${id}" class="del">Видалити</button></div>
      `;
      itemsEl.appendChild(el);
    });

    // делегирование удаления
    itemsEl.querySelectorAll('.del').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if (!confirm('Видалити цей матеріал?')) return;
        try {
          await deleteDoc(doc(db, 'media', id));
          loadItems();
        } catch (err) {
          alert('Ошибка удаления: ' + err.message);
        }
      });
    });
  }

  mediaForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('title').value.trim();
    const tag = document.getElementById('tag').value.trim();
    const tagColor = document.getElementById('tagColor').value.trim() || 'green';
    const file = document.getElementById('image').files[0];

    try {
      let imageUrl = '';
      if (file) {
        const storageRef = ref(storage, `media/${Date.now()}_${file.name}`);
        const uploadTask = uploadBytesResumable(storageRef, file);
        await new Promise((res, rej) => {
          uploadTask.on('state_changed', null, err => rej(err), async () => {
            imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
            res();
          });
        });
      }
      await addDoc(collection(db, 'media'), { title, tag, tagColor, imageUrl, date: serverTimestamp() });
      alert('Додано!');
      mediaForm.reset();
      loadItems();
    } catch (err) {
      alert('Ошибка: ' + err.message);
      console.error(err);
    }
  });

</script>
</body>
</html>
